<script>
  const radius = 120;
  let defaultNoise, isAudioPaused = false, audioReady = false;
  const audioElements = {};
  const nodes = [
    { lat: 41.311387, lon: -72.926065, name: "Woolsey Hall", audio: "woolsey.mp3" },
    { lat: 41.309662, lon: -72.930934, name: "University Theater", audio: "ut.mp3" },
    { lat: 41.311568, lon: -72.930431, name: "Off Broadway Theater", audio: "obt.mp3" },
    { lat: 41.309510, lon: -72.927423, name: "Battell Chapel", audio: "battell.mp3" },
    { lat: 41.310420, lon: -72.928195, name: "Berkeley College", audio: "berkeley.mp3" }
  ];

  const map = L.map('map').setView([0, 0], 15);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap &copy; CartoDB',
    subdomains: 'abcd',
    maxZoom: 20
  }).addTo(map);

  const userIcon = L.divIcon({ className: 'custom-marker', iconSize: [20, 20] });
  const userMarker = L.marker([0, 0], { icon: userIcon }).addTo(map);

  nodes.forEach(node => {
    L.marker([node.lat, node.lon]).addTo(map).bindPopup(node.name);
    node.circle = L.circle([node.lat, node.lon], {
      radius,
      color: "#007bff",
      fillColor: "#007bff",
      fillOpacity: 0.2,
      weight: 1
    }).addTo(map);
  });

  function unlockAudio() {
    nodes.forEach(node => {
      const audio = new Audio(node.audio);
      audio.loop = true;
      audio.volume = 0;
      audio.load();
      audio.play().catch(err => console.error(`Failed to start ${node.audio}`, err));
      audioElements[node.name] = { audio };
    });

    defaultNoise = new Audio("default.mp3");
    defaultNoise.loop = true;
    defaultNoise.volume = 0;
    defaultNoise.load();
    defaultNoise.play().catch(err => console.error("Failed to start defaultNoise", err));

    document.getElementById("audio-toggle-btn").textContent = "Play";
    audioReady = true;
    isAudioPaused = true;

    const overlay = document.getElementById("audio-unlock-overlay");
    overlay.classList.add("fade-out");
    setTimeout(() => overlay.style.display = "none", 500);
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Δφ / 2) ** 2 +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function updateLocation(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    userMarker.setLatLng([lat, lon]);
    map.setView([lat, lon], 15);

    const activeNodes = [];
    let closestNode = null;
    let minDistance = Infinity;

    nodes.forEach(node => {
      const distance = getDistance(lat, lon, node.lat, node.lon);
      if (distance <= radius) activeNodes.push(node.name);
      if (distance < minDistance) {
        minDistance = distance;
        closestNode = node;
      }
    });

    if (audioReady && !isAudioPaused) adjustAudioVolumes(activeNodes);
    updateStatusBox(lat, lon, closestNode, minDistance, activeNodes);
  }

  function adjustAudioVolumes(activeNodes) {
    const numActive = activeNodes.length;
    const volumePerTrack = numActive > 0 ? 1 / numActive : 0;

    activeNodes.forEach(name => {
      const { audio } = audioElements[name];
      fadeIn(audio, volumePerTrack);
    });

    Object.keys(audioElements).forEach(name => {
      if (!activeNodes.includes(name)) fadeOut(audioElements[name].audio);
    });

    if (numActive === 0) fadeIn(defaultNoise, 1);
    else fadeOut(defaultNoise);
  }

  function fadeIn(audio, targetVolume) {
    if (audio.paused) audio.play().catch(() => {});
    let vol = audio.volume;
    const step = 0.05;
    const interval = setInterval(() => {
      if (vol < targetVolume) {
        vol = Math.min(vol + step, targetVolume);
        audio.volume = vol;
      } else {
        clearInterval(interval);
      }
    }, 100);
  }

  function fadeOut(audio) {
    let vol = audio.volume;
    const step = 0.05;
    const interval = setInterval(() => {
      if (vol > 0) {
        vol = Math.max(vol - step, 0);
        audio.volume = vol;
      } else {
        audio.pause();
        clearInterval(interval);
      }
    }, 100);
  }

  function updateStatusBox(lat, lon, closestNode, minDistance, activeNodes) {
    document.getElementById("status-box").innerHTML = `
      <strong>Latitude:</strong> ${lat.toFixed(6)}<br>
      <strong>Longitude:</strong> ${lon.toFixed(6)}<br>
      <strong>Closest Node:</strong> ${closestNode ? closestNode.name : 'None'}<br>
      <strong>Active Tracks:</strong> ${activeNodes.length > 0 ? activeNodes.join(", ") : 'Default Noise'}
    `;
  }

  function toggleGlobalAudio() {
    if (!audioReady) return;

    isAudioPaused = !isAudioPaused;
    const btn = document.getElementById("audio-toggle-btn");
    btn.textContent = isAudioPaused ? "Play" : "Pause";

    if (isAudioPaused) {
      Object.values(audioElements).forEach(obj => {
        if (obj.audio.volume > 0) obj.audio.pause();
      });
      if (defaultNoise.volume > 0) defaultNoise.pause();
    } else {
      Object.values(audioElements).forEach(obj => {
        if (obj.audio.volume > 0) obj.audio.play().catch(() => {});
      });
      if (defaultNoise.volume > 0) defaultNoise.play().catch(() => {});
    }
  }

  function setGlobalVolume(val) {
    if (!audioReady) return;
    Object.values(audioElements).forEach(obj => obj.audio.volume = val);
    defaultNoise.volume = val;
  }

  function handleGeoError(error) {
    const box = document.getElementById("status-box");
    switch (error.code) {
      case error.PERMISSION_DENIED:
        box.innerHTML = `
          <strong>Location access denied.</strong><br>
          Please enable location permissions in your browser settings.
        `;
        break;
      case error.POSITION_UNAVAILABLE:
        box.innerHTML = `
          <strong>Location unavailable.</strong><br>
          Please enable GPS or move to an area with better signal.
        `;
        break;
      case error.TIMEOUT:
        box.innerHTML = `
          <strong>Location request timed out.</strong><br>
          Try refreshing the page with GPS enabled.
        `;
        break;
      default:
        box.innerHTML = `<strong>Unknown error getting location.</strong>`;
    }
  }

  // Try to get an initial quick location, then start watchPosition
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(updateLocation, handleGeoError, {
      enableHighAccuracy: true,
      timeout: 5000
    });

    navigator.geolocation.watchPosition(updateLocation, handleGeoError, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    });

    document.getElementById("status-box").innerHTML = "Searching for location...";
  } else {
    document.getElementById("status-box").innerHTML = `
      <strong>Geolocation is not supported by your browser.</strong>
    `;
  }
</script>
